" Instalador Vundle  ------------------------------------------------------ {{{

" Instalando el gestor de plugins Vundle
let iCanHazVundle=1
let vundle_readme=expand('~/.vim/bundle/vundle/README.md')
if !filereadable(vundle_readme)
    echo "Instalando Vundle..."
    echo ""
    silent !mkdir -p ~/.vim/bundle
    silent !git clone https://github.com/gmarik/vundle ~/.vim/bundle/vundle
    let iCanHazVundle=0
endif

" Requerido para Vundle
set nocompatible
filetype off

" Añadimos al runtimepath el Vundle
set rtp+=~/.vim/bundle/vundle/
call vundle#rc()

" }}}

" Listado de Plugins ------------------------------------------------------ {{{

Bundle 'gmarik/vundle'

" Navegador de archivos NEDTree
Bundle 'scrooloose/nerdtree'

" Powerline mejorada
Bundle 'bling/vim-airline'

" Autocompletion
Bundle 'davidhalter/jedi-vim'
Bundle 'AutoComplPop'

" Commenter - Permite comentar las líneas de código
Bundle 'scrooloose/nerdcommenter'

" Syntax
Bundle 'scrooloose/syntastic'

" Fuzzy Finder - Buscar archivos
Bundle 'kien/ctrlp.vim'

" Vim-easymotion - Permite desplazarse por el documento más rapido.
Bundle 'Lokaltog/vim-easymotion'

" Surround
Bundle 'tpope/vim-surround'

" Snippets
Bundle 'SirVer/ultisnips'
Bundle 'honza/vim-snippets'

" Temas de colores
Bundle 'morhetz/gruvbox'
Bundle 'altercation/vim-colors-solarized'

" }}}

" Instalación inicial de los plugins  ------------------------------------- {{{

if iCanHazVundle == 0
    echo "Instalando los Plugins ..."
    echo ""
    :BundleInstall
endif

filetype plugin indent on

" }}}

" Color ------------------------------------------------------------------- {{{
syntax on
"set background=dark

let &t_Co = 256
set background=dark
let solarized_termcolors=256
"colorscheme solarized
colorscheme gruvbox

" }}}

" Opciones basica --------------------------------------------------------- {{{
set encoding=utf-8

set ruler
set number
set laststatus=2
set noshowmode
set colorcolumn=80

" Mejorando el Wildmenu
set wildmenu
set wildmode=list:longest

" Deshabilita la creacion de backups.
set nobackup
set nowritebackup
set noswapfile

" Mostrar caracteres como espacios, tabs, etc...
set listchars=tab:▸\ ,extends:❯,precedes:❮,trail:⋅,eol:¬
set list
set lisp " Para que en el autocompletado me aparezcan las palabras con '-'.

set splitbelow " Ventana nueva abajo
set splitright " Ventan nueva a la derecha.
set autoread " Recargar archivo si fue modificado fuera de vim.

" Mejor autocompletado.
set complete=.,w,b,u,t
set completeopt=longest,menuone,preview
set omnifunc=syntaxcomplete#Complete

" Habilitamos el ratón
set mouse=a

au VimResized * :wincmd = " Redimensionar los splits al reducir la ventana.

" Solo mostrar el current line en la ventana actual y en normal mode.
set cursorline
augroup cline
    au!
    au WinLeave,InsertEnter * set nocursorline
    au WinEnter,InsertLeave * set cursorline
augroup END


" }}}

" Tabs, espacios, wrapping ------------------------------------------------ {{{

set tabstop=4
set shiftwidth=4
set softtabstop=4
set expandtab
set formatoptions=qrn1j

autocmd FileType yaml setlocal softtabstop=2 shiftwidth=2 tabstop=2 expandtab
autocmd FileType html setlocal softtabstop=2 shiftwidth=2 tabstop=2 expandtab
autocmd FileType python setlocal softtabstop=4 shiftwidth=4 tabstop=4 expandtab
autocmd FileType css setlocal softtabstop=2 shiftwidth=2 tabstop=2 expandtab
autocmd FileType javascript setlocal softtabstop=2 shiftwidth=2 tabstop=2 expandtab
autocmd FileType make setlocal softtabstop=8 shiftwidth=8 tabstop=8 noexpandtab

" }}}

" Remapeo de teclas ------------------------------------------------------- {{{

let mapleader=","

" Help key.
noremap <F1> <nop>
inoremap <F1> <nop>

" Abrir el .vimrc para editarlo.
nmap vimrc :tabnew ~/.vimrc<cr>

" Cerrar un archivo
nnoremap <leader>q <esc>:q<cr>

" Guardar archivo
noremap <F2> <esc>:w<cr>
inoremap <F2> <esc>:w<cr>
vnoremap <F2> <esc>:w<cr>

" Abrir el NERDTree
noremap <F3> :NERDTreeToggle<cr>
inoremap <F3> <esc>:NERDTreeToggle<cr>

" Encuentra un archivo abierto en el NERDTree
noremap <F4> :NERDTreeFind<CR>

" <ESC>
inoremap kj <esc>l

" Duplicar linea
nnoremap dl :t.<CR>

" Mover linea a linea
noremap j gj
noremap k gk

" Para mover bloques de texto y lineas.
nnoremap <C-j> :m .+1<CR>==
nnoremap <C-k> :m .-2<CR>==
inoremap <C-j> <Esc>:m .+1<CR>==gi
inoremap <C-k> <Esc>:m .-2<CR>==gi
vnoremap <C-j> :m '>+1<CR>gv=gv
vnoremap <C-k> :m '<-2<CR>gv=gv

" Se vuelver a seleccionar el texto despues de identarlo
vnoremap < <gv
vnoremap > >gv
nnoremap > <c-w>>
nnoremap < <c-w><

" Selecciona la linea actual sin seleccionar la identación.
nnoremap vv ^vg_

" Que el vat seleccione desde el incio al fin de lineas.
nnoremap vat vato0o$

" Seleccionar todo el documento.
nnoremap <leader>a ggVG

" Movimiento entre los Tabs
nnoremap tn :tabn<cr>
nnoremap tp :tabp<cr>
nnoremap tm :tabm<cr>
nnoremap tt :tabnew<cr>

" Cambiar entre ventanas
noremap <TAB><TAB> <C-w><C-w>

" Guardar cuando se requiere permisos de root
cmap w!! %!sudo tee > /dev/null %

" Limpiar busquedas
noremap <silent><space> :nohls<CR>

" }}}

" Busqueda ---------------------------------------------------------------- {{{
set incsearch
set ignorecase
set smartcase
set hlsearch
set scrolloff=10

" Mantener en el medio la busqueda.
nnoremap n nzzzv
nnoremap N Nzzzv

" }}}

" Plugins - Configuración ------------------------------------------------- {{{
" NERDTree ---------------------------------------------------------------- {{{

" No mostrar archivos con estas terminaciones.
let NERDTreeIgnore = ['\.pyc$', '\.pyo$', '__pycache__']

let NERDTreeHighlightCursorline = 1

" }}}
" Ctrl-p ------------------------------------------------------------------ {{{
let g:ctrlp_map = '<leader>e'
noremap <leader>b :CtrlPBuffer<CR>
noremap <leader>f :CtrlPLine<CR>
noremap <leader>m :CtrlPMRUFiles<CR>
"" Funcion para buscar por la palabra que se le pase
function! CtrlPWithSearchText(search_text, ctrlp_command_end)
    execute ':CtrlP' . a:ctrlp_command_end
    call feedkeys(a:search_text)
endfunction
        "" Busqueda de palabras
" Busca la palabra en el buffer
noremap <leader>wb :call CtrlPWithSearchText(expand('<cword>'), 'Buffer')<CR>
"" Busca la palabra en el Archivo
noremap <leader>wf :call CtrlPWithSearchText(expand('<cword>'), 'Line')<CR>
"" Busca la palabra como nombre de archivo
noremap <leader>we :call CtrlPWithSearchText(expand('<cword>'), '')<CR>
noremap <leader>pe :call CtrlPWithSearchText(expand('<cfile>'), '')<CR>
"" Que no cambie el working directory
let g:ctrlp_working_path_mode = 0
"" Ignorar estos archivos
let g:ctrlp_custom_ignore = {
            \ 'dir': '\v[\/](\.git|\.hg|\.svn)$',
            \ 'file': '\.pyc$\|\.pyo$',
            \ }
let ctrlp_filter_greps = "".
            \ "egrep -iv '\\.(" .
            \ "jar|class|swp|swo|log|so|o|pyc|jpe?g|png|gif|mo|po" .
            \ ")$' | " .
            \ "egrep -v '^(\\./)?(" .
            \ "deploy/|lib/|classes/|libs/|deploy/vendor/|.git/|.hg/|.svn/|.*migrations/|docs/build/" .
            \ ")'"
" }}}
" Jedi-vim ---------------------------------------------------------------- {{{
let g:jedi#use_tabs_not_buffers = 0
let g:jedi#show_call_signatures = 2
let g:jedi#completions_command = "<C-Space>"
let g:jedi#auto_close_doc = 1

" }}}
" Syntastic --------------------------------------------------------------- {{{
"let g:syntastic_python_flake8_post_args='--ignore=E501,D100,D101,D102,D103'
let g:syntastic_python_checkers = ['pylint']
let g:syntastic_python_pylint_post_args='--disable=C0301,C0111'
let g:syntastic_always_populate_loc_list = 0
let g:syntastic_auto_loc_list = 0
let g:syntastic_check_on_open = 0
let g:syntastic_check_on_wq = 0
" }}}
" }}}

" Folding ----------------------------------------------------------------- {{{
augroup ft_vim
    au!
    au FileType vim setlocal foldmethod=marker
    au FileType help setlocal textwidth=78
    au BufWinEnter *.txt if &ft == 'help' | wincmd L | endif
augroup END

" }}}

" Misc ----------------------------------------------------------------- {{{

" Highlight last spaces
highlight ExtraWhitespace ctermbg=red guibg=red
au InsertLeave,BufWinEnter * match ExtraWhitespace /\s\+$/
au ColorScheme * highlight ExtraWhitespace ctermbg=red guibg=red

" Remove last spaces
au BufWritePre *.txt :%s/\s\+$//e
au BufWritePre *.py :%s/\s\+$//e
au BufWritePre *.js :%s/\s\+$//e
au BufWritePre *.* :%s/\s\+$//e
" }}}
